name: Sync Branches with Main

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Main Branch
      uses: actions/checkout@v3
      with:
        ref: main

    - name: Fetch All Branches
      run: git fetch --all

    - name: Get All Branches
      id: get_branches
      run: |
        echo "BRANCHES=$(git branch -r | grep -v '\->' | grep -v 'main' | sed 's/origin\///' | tr '\n' ' ')" >> $GITHUB_ENV

    - name: Sync Branches with Main
      run: |
        for branch in ${BRANCHES}; do
          echo "Syncing branch $branch with main"
          git checkout $branch
          git merge --allow-unrelated-histories --ff-only origin/main || git merge --abort
          git push origin $branch
        done
      env:
        BRANCHES: ${{ env.BRANCHES }}
